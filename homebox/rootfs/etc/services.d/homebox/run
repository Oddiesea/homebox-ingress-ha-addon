#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Homebox
# This runs Homebox using HA Ingress
# ==============================================================================

# Create data directory if it doesn't exist
data_dir="/data"
mkdir -p "${data_dir}" || bashio::exit.nok "Could not create data directory"

# Set timezone if configured
if bashio::config.has_value 'timezone'; then
    TZ=$(bashio::config 'timezone')
    export TZ
    bashio::log.info "Timezone set to: ${TZ}"
fi

# Verify homebox binary exists and is executable
if [ ! -f /usr/bin/homebox ]; then
    bashio::log.error "Homebox binary not found at /usr/bin/homebox"
    bashio::exit.nok "Homebox binary missing"
fi

if [ ! -x /usr/bin/homebox ]; then
    bashio::log.error "Homebox binary is not executable"
    bashio::exit.nok "Homebox binary not executable"
fi

# Start Homebox
bashio::log.info "Starting Homebox..."
bashio::log.info "Data directory: ${data_dir}"
bashio::log.info "Port: 7745"

# Run homebox - use exec to replace shell process with homebox
# This ensures homebox runs as the service process
exec /usr/bin/homebox \
    --data "${data_dir}" \
    --port 7745

